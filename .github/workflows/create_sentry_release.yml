name: Create Sentry release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: EgorDm/gha-yarn-node-cache@v1
      
      - name: Install dependencies
        run: yarn install
      
      - name: Build application
        run: yarn build
        env:
          REACT_APP_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          REACT_APP_SHA: ${{ github.sha }}
          REACT_APP_BRANCH: main
          REACT_APP_OAUTH2_CLIENT_ID: ${{ secrets.CLIENT_ID }}

      - name: Create Sentry release (production)
        if: github.ref == 'refs/heads/main'
        uses: getsentry/action-release@v1.1.5
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: python-discord
          SENTRY_PROJECT: forms-frontend
        with:
          environment: production
          sourcemaps: ./build/static/js/
          version_prefix: forms-frontend@

      - name: Create Sentry release (deploy preview)
        if: github.ref != 'refs/heads/main'
        uses: getsentry/action-release@v1.1.5
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: python-discord
          SENTRY_PROJECT: forms-frontend
        with:
          environment: deploy-preview
          sourcemaps: ./build/static/js/
          version_prefix: forms-frontend@
